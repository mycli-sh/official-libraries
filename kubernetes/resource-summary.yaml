schemaVersion: 1
kind: command
metadata:
  name: Resource Summary
  slug: resource-summary
  description: Show CPU and memory usage, requests, and limits for pods
  tags: [kubernetes, resources, monitoring]
dependencies: [kubectl]
defaults:
  shell: /bin/bash
  timeout: 2m
  templateDelimiters: ["<%", "%>"]
args:
  positional: []
  flags:
    - name: namespace
      short: "n"
      type: string
      description: Filter to a specific namespace
      default: ""
    - name: all
      short: A
      type: bool
      description: Show pods across all namespaces
      default: "false"
steps:
  - name: resource-summary
    run: |
      set -euo pipefail
      NS_FLAG=""
      if [[ "<% .args.all %>" == "true" ]]; then NS_FLAG="--all-namespaces"; fi
      if [[ -n "<% .args.namespace %>" ]]; then NS_FLAG="--namespace=<% .args.namespace %>"; fi
      K8S_TPL='{{range .items}}{{$ns := .metadata.namespace}}{{$pod := .metadata.name}}{{range .spec.containers}}{{$ns}},{{$pod}},{{.name}},{{if .resources.requests.cpu}}{{.resources.requests.cpu}}{{else}}-{{end}},{{if .resources.limits.cpu}}{{.resources.limits.cpu}}{{else}}-{{end}},{{if .resources.requests.memory}}{{.resources.requests.memory}}{{else}}-{{end}},{{if .resources.limits.memory}}{{.resources.limits.memory}}{{else}}-{{end}}{{"\n"}}{{end}}{{end}}'
      SPEC_DATA=$(kubectl get pods ${NS_FLAG} -o go-template="${K8S_TPL}" 2>/dev/null)
      TOP_DATA=$(kubectl top pods ${NS_FLAG} --containers --no-headers 2>/dev/null || true)
      printf '%-20s %-40s %-20s %-10s %-10s %-10s %-10s %-10s %-10s\n' NAMESPACE POD CONTAINER CPU_USE CPU_REQ CPU_LIM MEM_USE MEM_REQ MEM_LIM
      printf '%-20s %-40s %-20s %-10s %-10s %-10s %-10s %-10s %-10s\n' -------- --- --------- ------- ------- ------- ------- ------- -------
      while IFS=',' read -r ns pod ctr cpu_req cpu_lim mem_req mem_lim; do
        [[ -z "$ns" ]] && continue
        cpu_use='-'; mem_use='-'
        if [[ -n "${TOP_DATA}" ]]; then
          top_line=$(echo "${TOP_DATA}" | awk -v ns="$ns" -v pod="$pod" -v ctr="$ctr" '$1==ns && $2==pod && $3==ctr {print $4,$5}')
          if [[ -n "$top_line" ]]; then
            cpu_use=$(echo "$top_line" | awk '{print $1}')
            mem_use=$(echo "$top_line" | awk '{print $2}')
          fi
        fi
        printf '%-20s %-40s %-20s %-10s %-10s %-10s %-10s %-10s %-10s\n' "$ns" "$pod" "$ctr" "$cpu_use" "$cpu_req" "$cpu_lim" "$mem_use" "$mem_req" "$mem_lim"
      done <<< "${SPEC_DATA}"
