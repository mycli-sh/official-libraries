schemaVersion: 1
kind: command
metadata:
  name: Rollout
  slug: rollout
  description: Manage deployment rollouts (status, restart, history)
  tags: [kubernetes, deployments, rollout]
dependencies: [kubectl]
defaults:
  shell: /bin/bash
  timeout: 2m
args:
  positional:
    - name: action
      description: "Rollout action: status, restart, history, undo"
    - name: resource
      description: "Resource to manage (e.g. deployment/nginx). Omit for interactive selection"
      required: false
      default: ""
  flags:
    - name: namespace
      short: "n"
      type: string
      description: Kubernetes namespace
      default: ""
steps:
  - name: rollout
    run: |
      set -euo pipefail
      NS_FLAG=""
      if [[ -n "{{.args.namespace}}" ]]; then NS_FLAG="--namespace={{.args.namespace}}"; fi

      RESOURCE="{{.args.resource}}"
      if [[ -z "$RESOURCE" ]]; then
        if command -v fzf &>/dev/null; then
          ITEMS=$(kubectl get deployments --no-headers ${NS_FLAG})
          if [[ -z "$ITEMS" ]]; then
            echo "No deployments found."
            exit 1
          fi
          DEPLOY=$(echo "$ITEMS" | fzf --prompt="Select deployment: " | awk '{print $1}')
          [[ -z "$DEPLOY" ]] && echo "No deployment selected." && exit 1
          RESOURCE="deployment/$DEPLOY"
        else
          echo "No resource specified. Available deployments:"
          kubectl get deployments ${NS_FLAG}
          echo ""
          echo "Tip: install fzf for interactive selection"
          exit 1
        fi
      fi

      ARGS=()
      if [[ -n "${NS_FLAG}" ]]; then ARGS+=(${NS_FLAG}); fi
      kubectl rollout "{{.args.action}}" "$RESOURCE" ${ARGS[@]+"${ARGS[@]}"}
