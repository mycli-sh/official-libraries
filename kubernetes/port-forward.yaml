schemaVersion: 1
kind: command
metadata:
  name: Port Forward
  slug: port-forward
  description: Forward local ports to a pod, service, or deployment
  tags: [kubernetes, networking, debugging]
dependencies: [kubectl]
defaults:
  shell: /bin/bash
  timeout: "0s"
  templateDelimiters: ["<%", "%>"]
args:
  positional:
    - name: target
      description: "Target resource (e.g. pod/name, svc/name, deploy/name). Omit for interactive selection"
      required: false
      default: ""
  flags:
    - name: ports
      short: p
      type: string
      description: "Port mapping (e.g. 8080:80, 3000). Omit for auto-discovery"
      default: ""
    - name: namespace
      short: "n"
      type: string
      description: Kubernetes namespace
      default: ""
    - name: all
      short: A
      type: bool
      description: Show resources across all namespaces
      default: "false"
steps:
  - name: port-forward
    run: |
      set -euo pipefail

      discover_ports() {
        local ns_arg="${1:-}"

        kubectl get services ${ns_arg} -o go-template='{{range .items}}{{$ns := .metadata.namespace}}{{$name := .metadata.name}}{{range .spec.ports}}{{$ns}} Service {{$name}} {{.port}}{{"\n"}}{{end}}{{end}}' 2>/dev/null || true

        kubectl get deployments ${ns_arg} -o go-template='{{range .items}}{{$ns := .metadata.namespace}}{{$name := .metadata.name}}{{range .spec.template.spec.containers}}{{range .ports}}{{$ns}} Deployment {{$name}} {{.containerPort}}{{"\n"}}{{end}}{{end}}{{end}}' 2>/dev/null || true

        kubectl get pods ${ns_arg} -o go-template='{{range .items}}{{$ns := .metadata.namespace}}{{$name := .metadata.name}}{{range .spec.containers}}{{range .ports}}{{$ns}} Pod {{$name}} {{.containerPort}}{{"\n"}}{{end}}{{end}}{{end}}' 2>/dev/null || true
      }

      discover_ports_for_target() {
        local kind="$1" name="$2" ns_arg="${3:-}"
        case "$kind" in
          svc|service|Service)
            kubectl get service "$name" ${ns_arg} -o jsonpath='{range .spec.ports[*]}{.port}{"\n"}{end}' 2>/dev/null || true
            ;;
          deploy|deployment|Deployment)
            kubectl get deployment "$name" ${ns_arg} -o jsonpath='{range .spec.template.spec.containers[*]}{range .ports[*]}{.containerPort}{"\n"}{end}{end}' 2>/dev/null || true
            ;;
          pod|Pod)
            kubectl get pod "$name" ${ns_arg} -o jsonpath='{range .spec.containers[*]}{range .ports[*]}{.containerPort}{"\n"}{end}{end}' 2>/dev/null || true
            ;;
        esac
      }

      NS_FLAG=""
      if [[ "<% .args.all %>" == "true" ]]; then NS_FLAG="--all-namespaces"; fi
      if [[ -n "<% .args.namespace %>" ]]; then NS_FLAG="--namespace=<% .args.namespace %>"; fi

      TARGET="<% .args.target %>"
      REMOTE_PORT=""

      if [[ -z "$TARGET" ]]; then
        if command -v fzf &>/dev/null; then
          ALL_PORTS=$(discover_ports "${NS_FLAG:---all-namespaces}" | sed '/^$/d' | sort -u)
          if [[ -z "$ALL_PORTS" ]]; then
            echo "No resources with ports found."
            exit 1
          fi
          HEADER="NAMESPACE KIND NAME PORT"
          SELECTION=$(echo "$ALL_PORTS" | column -t | fzf --prompt="Select resource: " --header="$HEADER")
          [[ -z "$SELECTION" ]] && echo "No resource selected." && exit 1

          SEL_NS=$(echo "$SELECTION" | awk '{print $1}')
          SEL_KIND=$(echo "$SELECTION" | awk '{print $2}')
          SEL_NAME=$(echo "$SELECTION" | awk '{print $3}')
          REMOTE_PORT=$(echo "$SELECTION" | awk '{print $4}')

          case "$SEL_KIND" in
            Pod)        TARGET="pod/$SEL_NAME" ;;
            Service)    TARGET="svc/$SEL_NAME" ;;
            Deployment) TARGET="deploy/$SEL_NAME" ;;
          esac
          NS_FLAG="--namespace=$SEL_NS"
        else
          echo "No target specified."
          echo ""
          echo "Usage: port-forward <target> [-p port]"
          echo "  e.g. port-forward svc/my-service"
          echo "  e.g. port-forward deploy/my-app -p 8080:80"
          echo ""
          echo "Tip: install fzf for interactive selection"
          exit 1
        fi
      fi

      PORTS="<% .args.ports %>"
      if [[ -z "$PORTS" ]]; then
        if [[ -n "$REMOTE_PORT" ]]; then
          PORTS="${REMOTE_PORT}:${REMOTE_PORT}"
        else
          KIND=$(echo "$TARGET" | cut -d/ -f1)
          NAME=$(echo "$TARGET" | cut -d/ -f2)
          FOUND_PORTS=$(discover_ports_for_target "$KIND" "$NAME" "$NS_FLAG" | sed '/^$/d' | sort -u)

          if [[ -z "$FOUND_PORTS" ]]; then
            echo "Error: no ports found on $TARGET. Use -p to specify a port mapping."
            exit 1
          fi

          PORT_COUNT=$(echo "$FOUND_PORTS" | wc -l | tr -d ' ')
          if [[ "$PORT_COUNT" -eq 1 ]]; then
            REMOTE_PORT=$(echo "$FOUND_PORTS" | tr -d ' ')
            PORTS="${REMOTE_PORT}:${REMOTE_PORT}"
            echo "Auto-detected port: $REMOTE_PORT"
          else
            if command -v fzf &>/dev/null; then
              REMOTE_PORT=$(echo "$FOUND_PORTS" | fzf --prompt="Select port for $TARGET: ")
              [[ -z "$REMOTE_PORT" ]] && echo "No port selected." && exit 1
              REMOTE_PORT=$(echo "$REMOTE_PORT" | tr -d ' ')
              PORTS="${REMOTE_PORT}:${REMOTE_PORT}"
            else
              echo "Multiple ports found on $TARGET:"
              echo "$FOUND_PORTS" | sed 's/^/  /'
              echo ""
              echo "Use -p to specify which port. Example: -p 8080:80"
              exit 1
            fi
          fi
        fi
      fi

      ARGS=()
      if [[ -n "${NS_FLAG}" ]]; then ARGS+=(${NS_FLAG}); fi
      echo "Forwarding $PORTS â†’ $TARGET"
      kubectl port-forward "$TARGET" "$PORTS" ${ARGS[@]+"${ARGS[@]}"}
