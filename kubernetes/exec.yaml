schemaVersion: 1
kind: command
metadata:
  name: Exec
  slug: exec
  description: Execute a command in a running container
  tags: [kubernetes, exec, debugging]
dependencies: [kubectl]
defaults:
  shell: /bin/bash
  timeout: "0s"
args:
  positional:
    - name: pod
      description: Name of the pod (omit for interactive selection)
      required: false
      default: ""
  flags:
    - name: namespace
      short: "n"
      type: string
      description: Kubernetes namespace
      default: ""
    - name: container
      short: c
      type: string
      description: Container name (for multi-container pods)
      default: ""
    - name: command
      short: x
      type: string
      description: Command to execute (default is /bin/sh)
      default: /bin/sh
steps:
  - name: exec
    run: |
      set -euo pipefail
      NS_FLAG=""
      if [[ -n "{{.args.namespace}}" ]]; then NS_FLAG="--namespace={{.args.namespace}}"; fi

      POD="{{.args.pod}}"
      if [[ -z "$POD" ]]; then
        if command -v fzf &>/dev/null; then
          ITEMS=$(kubectl get pods --no-headers ${NS_FLAG})
          if [[ -z "$ITEMS" ]]; then
            echo "No pods found."
            exit 1
          fi
          POD=$(echo "$ITEMS" | fzf --prompt="Select pod: " | awk '{print $1}')
          [[ -z "$POD" ]] && echo "No pod selected." && exit 1
        else
          echo "No pod specified. Available pods:"
          kubectl get pods ${NS_FLAG}
          echo ""
          echo "Tip: install fzf for interactive selection"
          exit 1
        fi
      fi

      ARGS=()
      if [[ -n "${NS_FLAG}" ]]; then ARGS+=(${NS_FLAG}); fi
      if [[ -n "{{.args.container}}" ]]; then ARGS+=(--container "{{.args.container}}"); fi

      CMD="{{.args.command}}"
      if [[ "$CMD" == "/bin/sh" || "$CMD" == "/bin/bash" || "$CMD" == "sh" || "$CMD" == "bash" ]]; then
        kubectl exec -it "$POD" ${ARGS[@]+"${ARGS[@]}"} -- $CMD
      else
        kubectl exec -it "$POD" ${ARGS[@]+"${ARGS[@]}"} -- /bin/sh -c "$CMD"
      fi
